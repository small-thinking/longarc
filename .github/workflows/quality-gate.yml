name: Quality Gate

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  governance:
    name: Governance checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate governance files
        run: bash scripts/ci/validate_governance.sh

  python-quality:
    name: Python lint, type, and tests
    runs-on: ubuntu-latest
    needs: governance
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff mypy pytest

      - name: Ruff
        run: |
          if ! git ls-files '*.py' | grep -q .; then
            echo "No Python files yet; skipping ruff."
            exit 0
          fi
          ruff check .

      - name: Mypy
        run: |
          if ! git ls-files '*.py' | grep -q .; then
            echo "No Python files yet; skipping mypy."
            exit 0
          fi
          if [ -d py/src ]; then
            mypy py/src
          elif [ -d src ]; then
            mypy src
          else
            echo "Python files detected, but expected source directory py/src or src is missing."
            exit 1
          fi

      - name: Pytest
        run: |
          if ! git ls-files '*.py' | grep -q .; then
            echo "No Python files yet; skipping pytest."
            exit 0
          fi
          if [ -d py/tests ]; then
            pytest -q py/tests
          elif [ -d tests ]; then
            pytest -q tests
          else
            echo "Python files detected, but no tests directory found (expected py/tests or tests)."
            exit 1
          fi
